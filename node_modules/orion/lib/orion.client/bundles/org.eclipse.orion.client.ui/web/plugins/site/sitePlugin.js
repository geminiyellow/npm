!function(e,t){"function"==typeof define&&define.amd?define("orion/Deferred",t):"object"==typeof exports?module.exports=t():(e.orion=e.orion||{},e.orion.Deferred=t())}(this,function(){function e(){for(var e;e=i.shift();)e();s=!1}function t(e){i.push(e),s||(s=!0,a())}function n(e){return function(t){e(t)}}function r(e,t,r){try{var o=e(t),i=o&&("object"==typeof o||"function"==typeof o)&&o.then;if("function"==typeof i)if(o===r.promise)r.reject(new TypeError);else{var s=o.cancel;"function"==typeof s?r._parentCancel=s.bind(o):delete r._parentCancel,i.call(o,n(r.resolve),n(r.reject),n(r.progress))}else r.resolve(o)}catch(a){r.reject(a)}}function o(){function e(){for(var e;e=u.shift();){var t=e.deferred,n="fulfilled"===c?"resolve":"reject",o=e[n];"function"==typeof o?r(o,a,t):t[n](a)}}function n(n){delete l._parentCancel,c="rejected",a=n,u.length&&t(e)}function i(r){function s(e){return function(t){c&&"assumed"!==c||e(t)}}delete l._parentCancel;try{var f=r&&("object"==typeof r||"function"==typeof r)&&r.then;if("function"==typeof f)if(r===l)n(new TypeError);else{c="assumed";var p=r&&r.cancel;if("function"!=typeof p){var d=new o;r=d.promise;try{f(d.resolve,d.reject,d.progress)}catch(g){d.reject(g)}p=r.cancel,f=r.then}a=r,f.call(r,s(i),s(n)),l._parentCancel=p.bind(r)}else c="fulfilled",a=r,u.length&&t(e)}catch(h){s(n)(h)}}function s(){var e=l._parentCancel;if(e)delete l._parentCancel,e();else if(!c){var t=new Error("Cancel");t.name="Cancel",n(t)}}var a,c,u=[],l=this;this.resolve=function(e){return c||i(e),l},this.reject=function(e){return c||n(e),l},this.progress=function(e){return c||u.forEach(function(t){if(t.progress)try{t.progress(e)}catch(n){}}),l.promise},this.cancel=function(){return l._parentCancel?setTimeout(s,0):s(),l},this.then=function(n,r,i){var s=new o;return s._parentCancel=l.promise.cancel,u.push({resolve:n,reject:r,progress:i,deferred:s}),("fulfilled"===c||"rejected"===c)&&t(e),s.promise},this.promise={then:l.then,cancel:l.cancel}}var i=[],s=!1,a=function(){if("undefined"!=typeof process&&"function"==typeof process.nextTick){var t=process.nextTick;return function(){t(e)}}if("function"==typeof MutationObserver){var n=document.createElement("div"),r=new MutationObserver(e);return r.observe(n,{attributes:!0}),function(){n.setAttribute("class","_tick")}}return function(){setTimeout(e,0)}}();return o.all=function(e,t){function n(e,t){a||(s[e]=t,0===--i&&c.resolve(s))}function r(e,r){if(!a){if(t)try{return void n(e,t(r))}catch(o){r=o}c.reject(r)}}var i=e.length,s=[],a=!1,c=new o;return c.then(void 0,function(){a=!0,e.forEach(function(e){e.cancel&&e.cancel()})}),0===i?c.resolve(s):e.forEach(function(e,t){e.then(n.bind(void 0,t),r.bind(void 0,t))}),c.promise},o.when=function(e,t,n,r){var i,s;return e&&"function"==typeof e.then?i=e:(s=new o,s.resolve(e),i=s.promise),i.then(t,n,r)},o}),function(e,t){"function"==typeof define&&define.amd?define("orion/plugin",["orion/Deferred"],t):"object"==typeof exports?module.exports=t(require("orion/Deferred")):(e.orion=e.orion||{},e.orion.PluginProvider=t(e.orion.Deferred))}(this,function(e){function t(e,t){this.__objectId=e,this.__methods=t}function n(n){function r(e){d&&("undefined"==typeof ArrayBuffer&&(e=JSON.stringify(e)),d===self?d.postMessage(e):d.postMessage(e,"*"))}function o(){var e=[];return Object.keys(w).forEach(function(t){var n=w[t];e.push({serviceId:t,names:n.names,methods:n.methods,properties:n.properties})}),{headers:f||{},services:e}}function i(e,t){if(t&&t instanceof XMLHttpRequest){var n,r;try{n=t.status,r=t.statusText}catch(o){n=0,r=""}return{status:n||0,statusText:r}}return t}function s(e){var t=e?JSON.parse(JSON.stringify(e,i)):e;return e instanceof Error&&(t.__isError=!0,t.message=t.message||e.message,t.name=t.name||e.name),t}function a(n){if(!d)return(new e).reject(new Error("plugin not connected"));n.id=String(g++);var r=new e;y[n.id]=r,r.then(null,function(e){p&&e instanceof Error&&"Cancel"===e.name&&P({requestId:n.id,method:"cancel",params:e.message?[e.message]:[]})});var o=Object.prototype.toString;return n.params.forEach(function(e,i){if("[object Object]"===o.call(e)&&!(e instanceof t)){var s,a;for(s in e)"[object Function]"===o.call(e[s])&&(a=a||[],a.push(s));if(a){var c=h++;b[c]=e;var u=function(){delete b[c]};r.then(u,u),n.params[i]=new t(c,a)}}}),P(n),r.promise}function c(e,t){e||0===e?P({id:e,result:null,error:t}):console.log(t)}function u(e,t,n,r){r.forEach(function(e,t){if(e&&"undefined"!=typeof e.__objectId){var n={};e.__methods.forEach(function(t){n[t]=function(){return a({objectId:e.__objectId,method:t,params:Array.prototype.slice.call(arguments)})}}),r[t]=n}});var o=void 0===typeof e?null:{id:e,result:null,error:null};try{var i=n.apply(t,r);if(!o)return;i&&"function"==typeof i.then?(v[e]=i,i.then(function(t){delete v[e],o.result=t,P(o)},function(t){v[e]&&(delete v[e],o.error=s(t),P(o))},function(){P({responseId:e,method:"progress",params:Array.prototype.slice.call(arguments)})})):(o.result=i,P(o))}catch(c){o&&(o.error=s(c),P(o))}}function l(e){if(e.source===d||"undefined"==typeof window){var t="string"!=typeof e.data?e.data:JSON.parse(e.data);try{if(t.method){var n=t.method,r=t.params||[];if("serviceId"in t){var o=w[t.serviceId];o||c(t.id,"service not found"),o=o.implementation,n in o?u(t.id,o,o[n],r):c(t.id,"method not found")}else if("objectId"in t){var i=b[t.objectId];i||c(t.id,"object not found"),!n in i?u(t.id,i,i[n],r):c(t.id,"method not found")}else if("requestId"in t){var s=v[t.requestId];s&&"cancel"===n&&s.cancel&&s.cancel.apply(s,r)}else{if(!("responseId"in t))throw new Error("Bad method: "+t.method);var a=y[t.responseId];a&&"progress"===n&&a.progress&&a.progress.apply(a,r)}}else{var l=y[String(t.id)];delete y[String(t.id)],t.error?l.reject(t.error):l.resolve(t.result)}}catch(f){console.log("Plugin._messageHandler "+f)}}}var f=n,p=!1,d=null,g=0,h=0,m=0,v={},y={},b={},w={},P=r;this.updateHeaders=function(e){if(p)throw new Error("Cannot update headers. Plugin Provider is connected");f=e},this.registerService=function(e,t,n){if(p)throw new Error("Cannot register service. Plugin Provider is connected");"string"==typeof e?e=[e]:Array.isArray(e)||(e=[]);var r=null,o=[];for(r in t)"function"==typeof t[r]&&o.push(r);w[m++]={names:e,methods:o,implementation:t,properties:n||{},listeners:{}}},this.registerServiceProvider=this.registerService,this.connect=function(e,t){if(p)return void(e&&e());if("undefined"==typeof window)d=self;else if(window!==window.parent)d=window.parent;else{if(null===window.opener)return void(t&&t("No valid plugin target"));d=window.opener}addEventListener("message",l,!1);var n={method:"plugin",params:[o()]};r(n),p=!0,e&&e()},this.disconnect=function(){p&&(removeEventListener("message",l),d=null,p=!1)}}return n}),define("orion/i18nUtil",["require","orion/Deferred"],function(e,t){function n(e){var t=arguments;return e.replace(/\$\{([^\}]+)\}/g,function(e,n){return t[(n<<0)+1]})}function r(e){var t=localStorage.getItem("orion/messageBundle/"+e);if(t){var n=JSON.parse(t);if(n._expires&&n._expires>(new Date).getTime())return delete n._expires,n}return null}function o(e,t){t._expires=(new Date).getTime()+9e5,localStorage.setItem("orion/messageBundle/"+e,JSON.stringify(t)),delete t._expires}function i(n){function i(t){t?e(["i18n!"+n],function(e){e&&o(n,e),c.resolve(e)}):a(new Error(n))}function a(e){c.reject(e)}if(s[n])return s[n];var c=new t;s[n]=c;var u=r(n);if(u)return c.resolve(u),c;try{e([n],i,a)}catch(l){e(["orion/i18n!"+n],i,a)}return c}var s={};return{getMessageBundle:i,formatMessage:n}}),define("orion/xhr",["orion/Deferred"],function(e){function t(e,t,n,r){var o,i="undefined"!=typeof n.response?n.response:n.responseText,s="string"==typeof i?i:null;try{o=n.status}catch(a){o=0}var c={args:t,response:i,responseText:s,status:o,url:e,xhr:n};return"undefined"!=typeof r&&(c.error=r),c}function n(n,r,o){o=o||{};var i,s=arguments.length>3&&arguments[3]?arguments[3]:new XMLHttpRequest,a=new e,c=o.headers||{},u=o.log||!1;"undefined"==typeof c["X-Requested-With"]&&(c["X-Requested-With"]="XMLHttpRequest"),"undefined"==typeof o.data||"POST"!==n&&"PUT"!==n||(i=o.data);var l=!1,f=!1;a.promise.then(void 0,function(e){l=!0,!f&&e instanceof Error&&"Cancel"===e.name&&s.abort()}),s.onabort=function(){if(f=!0,!l){var e=new Error("Cancel");e.name="Cancel",a.reject(e)}},s.onload=function(){var e=t(r,o,s);200<=s.status&&s.status<400?a.resolve(e):(a.reject(e),u&&"undefined"!=typeof console&&console.log(new Error(s.statusText)))},s.onerror=function(){var e=t(r,o,s);a.reject(e),u&&"undefined"!=typeof console&&console.log(new Error(s.statusText))},s.onprogress=function(e){e.xhr=s,a.progress(e)};try{if(s.open(n,r,!0),"string"==typeof o.responseType&&(s.responseType=o.responseType),"number"==typeof o.timeout)if("number"==typeof s.timeout)s.timeout=o.timeout,s.addEventListener("timeout",function(){a.reject(t(r,o,s,"Timeout exceeded"))});else{var p=setTimeout(function(){a.reject(t(r,o,s,"Timeout exceeded"))},o.timeout);a.promise.then(clearTimeout.bind(null,p),clearTimeout.bind(null,p))}Object.keys(c).forEach(function(e){s.setRequestHeader(e,c[e])}),s.send(i||null)}catch(d){a.reject(t(r,o,s,d))}return a.promise}return n}),define("orion/regex",[],function(){function e(e){return e.replace(/([\\$\^*\/+?\.\(\)|{}\[\]])/g,"\\$&")}function t(e){var t=/^\s*\/(.+)\/([gim]{0,3})\s*$/.exec(e);return t?{pattern:t[1],flags:t[2]}:null}return{escape:e,parse:t}}),define("plugins/site/siteServiceImpl",["require","orion/i18nUtil","orion/xhr","orion/regex"],function(e,t,n,r){function o(e){var t=document.createElement("a");return t.href=e,t.href}function i(){var t=e.toUrl("._"),n=o(t);return n.substring(0,n.length-2)}function s(e){return-1!==e.indexOf(":")?e.substring(e.indexOf(window.location.host)+window.location.host.length):e}function a(e,t,n){return e.HostingStatus.URL+("/"!==t[0]?"/":"")+t+(n.Directory?"/":"")}function c(e){return new RegExp("^/").test(e)}function u(e){return h.href=e,h.href}function l(e){return e&&"object"==typeof e&&Object.keys(e).forEach(function(t){var n=e[t];-1!==t.indexOf("Location")?e[t]=u(n):l(n)}),e}function f(e,t){for(var n,r=e.split("/"),o=r[1],i=0;i<t.length;i++){var s=t[i];if(s.Id===o){r[1]=s.Name,n=r.join("/");break}}return n}function p(e,t,r){return r&&"undefined"!=typeof r.data&&(r.data=JSON.stringify(r.data)),n.apply(null,Array.prototype.slice.call(arguments)).then(function(e){return JSON.parse(e.response||null)})}function d(e){this.projects={},this.getProjects=function(t){var n={"Orion-Version":"1"};return this.projects[t]||(this.projects[t]=p("GET",e,{headers:n}).then(function(e){for(var r,o=e.Workspaces,i=0;i<o.length&&(r=o[i],r.Id!==t);i++);return p("GET",r.Location,{headers:n}).then(function(e){return e.Children||[]})})),this.projects[t]}}function g(e,n,o){this.filePrefix=e,this.cache=new d(n),this.makeAbsolute=n&&-1!==n.indexOf("://"),this.selfHostingRules=o;var a=o.Rules,c=o.Types.File,u=o.Types.API;this._generateSelfHostingMappings=function(e){var n="http://localhost"+s(i());return a.map(function(r){var o;return o=r.type===c?t.formatMessage.apply(t,[r.targetPattern].concat(e)):t.formatMessage(r.targetPattern,n),{Source:r.source,Target:o}})},this._matchesSelfHostingTemplate=function(e,t){var n=/(\$\{[^}]+?\})/,o=r.escape("http://localhost")+"(:\\d+)?"+r.escape(s(i()));return a.every(function(i){return t.Mappings.some(function(t){if(t.Source===i.source){var s;i.type===c?s=r.escape(e)+".*?":i.type===u&&(s=o);var a=[];return i.targetPattern.split(n).forEach(function(e){a.push(n.test(e)?s:r.escape(e))}),new RegExp(a.join("")).test(t.Target)}return!1})})}}var h=document.createElement("a");return g.prototype={getSiteConfigurations:function(){var t=e.toUrl("site._");return t=t.substring(0,t.length-2),p("GET",t,{headers:{"Orion-Version":"1"},timeout:15e3}).then(function(e){return e.SiteConfigurations}).then(function(e){return this.makeAbsolute&&l(e),e}.bind(this))},loadSiteConfiguration:function(e){return p("GET",e,{headers:{"Orion-Version":"1"},timeout:15e3}).then(function(e){return this.makeAbsolute&&l(e),e}.bind(this))},createSiteConfiguration:function(t,n,r,o,i){function s(e){return e.replace(/ /g,"-").replace(/[^A-Za-z0-9-_]/g,"").toLowerCase()}var a={Name:t,Workspace:n,HostHint:s(t)};r&&(a.Mappings=r),o&&(a.HostHint=o),i&&(a.HostingStatus=i);var c=e.toUrl("site._");return c=c.substring(0,c.length-2),p("POST",c,{data:a,headers:{"Content-Type":"application/json; charset=utf-8","Orion-Version":"1"},timeout:15e3}).then(function(e){return this.makeAbsolute&&l(e),e}.bind(this))},updateSiteConfiguration:function(e,t){return p("PUT",e,{data:t,headers:{"Content-Type":"application/json; charset=utf-8","Orion-Version":"1"},timeout:15e3}).then(function(e){return this.makeAbsolute&&l(e),e}.bind(this))},deleteSiteConfiguration:function(e){return p("DELETE",e,{headers:{"Orion-Version":"1"},timeout:15e3}).then(function(e){return this.makeAbsolute&&l(e),e}.bind(this))},toInternalForm:function(e){var t,n=s(this.filePrefix),r=s(e);return 0===r.indexOf(n)&&(t=r.substring(n.length)),"/"===t[t.length-1]&&(t=t.substring(0,t.length-1)),t},toFileLocation:function(t){function n(e){return e.filter(function(e){return""!==e})}var r=e.toUrl(this.filePrefix+t+"._");r=r.substring(0,r.length-2);var i=t.split("/");return 1===n(i).length&&(r+="/"),s(o(r))},getMappingObject:function(e,t,n){var r=this.toInternalForm(t);return this.cache.getProjects(e.Workspace).then(function(e){var t=f(r,e);return{Source:n,Target:r,FriendlyPath:t||n}})},getMappingProposals:function(e){var t=this;return this.cache.getProjects(e.Workspace).then(function(e){return e.map(function(e){return{Source:"/"+e.Name,Target:t.toInternalForm(e.Location),FriendlyPath:"/"+e.Name}})})},updateMappingsDisplayStrings:function(e){return this.cache.getProjects(e.Workspace).then(function(t){for(var n=e.Mappings,r=0;r<n.length;r++){var o=n[r];c(o.Target)&&(o.FriendlyPath=f(o.Target,t))}return e})},parseInternalForm:function(e,t){return c(t)?this.cache.getProjects(e.Workspace).then(function(e){for(var n=t.split("/"),r=0;r<e.length;r++){var o=e[r];if(n[1]===o.Name)return n[1]=o.Id,n.join("/")}}):null},isSelfHostingSite:function(e){var t=this;return this.cache.getProjects(e.Workspace).then(function(n){return n.some(function(n){var r=t.toInternalForm(n.Location);return t._matchesSelfHostingTemplate(r,e)})})},convertToSelfHosting:function(e,t){var n=t.map(this.toInternalForm.bind(this)),r=this._generateSelfHostingMappings(n);return e.Mappings=r,e},getURLOnSite:function(e,t){var n=e.Mappings,r=this.toInternalForm(t.Location);if(!n)return null;for(var o=0;o<n.length;o++){var i=n[o];if(i.Target===r)return a(e,i.Source,t)}return null}},{SiteImpl:g}}),define("plugins/site/selfHostingRules",[],function(){var e=0,t=1,n=[{type:e,source:"/",targetPattern:"${0}/bundles/org.eclipse.orion.client.ui/web/index.html"},{type:e,source:"/",targetPattern:"${0}/bundles/org.eclipse.orion.client.ui/web"},{type:e,source:"/",targetPattern:"${0}/bundles/org.eclipse.orion.client.users/web"},{type:e,source:"/",targetPattern:"${0}/bundles/org.eclipse.orion.client.core/web"},{type:e,source:"/",targetPattern:"${0}/bundles/org.eclipse.orion.client.editor/web"},{type:e,source:"/",targetPattern:"${0}/bundles/org.eclipse.orion.client.cf/web"},{type:e,source:"/",targetPattern:"${0}/bundles/org.eclipse.orion.client.git/web"},{type:e,source:"/",targetPattern:"${0}/bundles/org.eclipse.orion.client.javascript/web"},{type:e,source:"/",targetPattern:"${0}/bundles/org.eclipse.orion.client.webtools/web"},{type:t,source:"/file",targetPattern:"${0}file"},{type:t,source:"/prefs",targetPattern:"${0}prefs"},{type:t,source:"/workspace",targetPattern:"${0}workspace"},{type:t,source:"/users",targetPattern:"${0}users"},{type:t,source:"/authenticationPlugin.html",targetPattern:"${0}authenticationPlugin.html"},{type:t,source:"/login",targetPattern:"${0}login"},{type:t,source:"/loginstatic",targetPattern:"${0}loginstatic"},{type:t,source:"/useremailconfirmation",targetPattern:"${0}useremailconfirmation"},{type:t,source:"/site",targetPattern:"${0}site"},{type:t,source:"/gitapi",targetPattern:"${0}gitapi"},{type:t,source:"/xfer",targetPattern:"${0}xfer"},{type:t,source:"/filesearch",targetPattern:"${0}filesearch"},{type:t,source:"/index.jsp",targetPattern:"${0}index.jsp"},{type:t,source:"/plugins/git",targetPattern:"${0}plugins/git"},{type:t,source:"/plugins/user",targetPattern:"${0}plugins/user"},{type:t,source:"/logout",targetPattern:"${0}logout"},{type:t,source:"/mixlogin/manageopenids",targetPattern:"${0}mixlogin/manageopenids"},{type:t,source:"/openids",targetPattern:"${0}openids"},{type:t,source:"/task",targetPattern:"${0}task"},{type:t,source:"/help",targetPattern:"${0}help"},{type:t,source:"/docker",targetPattern:"${0}docker"}];return{Rules:n,Types:{File:e,API:t}}}),define("plugins/site/sitePlugin",["orion/plugin","plugins/site/siteServiceImpl","plugins/site/selfHostingRules"],function(e,t,n){function r(e){var t=document.createElement("a");return t.href=e,t.href}function o(e){e=r(e);try{if(window.location.host===parent.location.host&&window.location.protocol===parent.location.protocol)return e.substring(parent.location.href.indexOf(parent.location.host)+parent.location.host.length)}catch(t){}return e}function i(e){return[{source:"Location|Directory"},{source:"Location",match:"^"+e}]}var s=o("../../site"),a=o("../../file"),c=o("../../workspace"),u=document.createElement("a");u.href="../../mixloginstatic/LoginWindow.html";var l=u.href,f={name:"Orion Site Service",version:"1.0",description:"This plugin provides virtual site support for hosting client web applications from your Orion workspace.",login:l},p=new e(f),d=document.createElement("a");d.href="/",p.registerService("orion.page.link.category",null,{id:"sites",nameKey:"Sites",nls:"orion/nls/messages",imageClass:"core-sprite-sites",order:50,uriTemplate:"{+OrionHome}/sites/"}),p.registerService("orion.page.link",null,{nameKey:"Sites",id:"orion.sites",nls:"orion/nls/messages",category:"sites",order:1e3,uriTemplate:"{+OrionHome}/sites/sites.html"}),p.registerService("orion.page.link",null,{nameKey:"Sites",id:"orion.sites.2",nls:"orion/nls/messages",category:"sites",order:10,uriTemplate:"{+OrionHome}/sites/sites.html"}),p.registerService("orion.navigate.command",null,{id:"orion.site."+d.hostname+".viewon",nameKey:"View on Site",tooltipKey:"View this file or folder on a web site hosted by Orion",nls:"orion/nls/messages",forceSingleItem:!0,category:"sites",validationProperties:i(a),uriTemplate:"{+OrionHome}/sites/view.html#,file={,Location}"}),p.registerService("orion.page.link.related",null,{id:"orion.site."+d.hostname+".viewon",nameKey:"View on Site",tooltipKey:"View this file or folder on a web site hosted by Orion",nls:"orion/nls/messages",category:"sites",validationProperties:i(a),uriTemplate:"{+OrionHome}/sites/view.html#,file={,Location}"}),p.registerService("orion.site",new t.SiteImpl(a,c,n),{id:"orion.site."+d.hostname,name:"Orion Sites at "+d.hostname,pattern:s,filePattern:a,canSelfHost:!0,selfHostingConfig:{folders:[{name:"org.eclipse.orion.client",labelKey:"orionClientLabel",nls:"orion/sites/nls/messages"}]}}),p.connect()});